<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Generator - ByteDance Direct API</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .api-selector {
            background: #f8f9fa;
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #e9ecef;
        }

        .api-selector button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 10px;
            font-weight: 500;
        }

        .api-selector button.active {
            background: #dc3545;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .input-section h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
            font-family: inherit;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .generate-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .results-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            min-height: 400px;
        }

        .results-section h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: 500;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            text-align: center;
        }

        .status.waiting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #856404;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-text {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .image-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .image-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .download-btn:hover {
            background: #218838;
        }

        .download-all-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .download-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(40, 167, 69, 0.3);
        }

        .download-all-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .empty-state {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 40px 20px;
        }

        .history-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            margin-top: 20px;
        }

        .history-toggle {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-bottom: 15px;
        }

        .history-panel {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé® AI Image Generator</h1>
            <p>Direct ByteDance Seedream V4 API - Instant Results!</p>
            <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.9rem;">
                ‚ö†Ô∏è <strong>CORS Limitation:</strong> This API requires deployment to a web server (not localhost). 
                For local testing, use the Kie.ai version instead.
            </div>
        </div>

        <div class="api-selector">
            <button onclick="switchToKieAI()">Kie.ai API</button>
            <button class="active" onclick="switchToByteDance()">ByteDance Direct API</button>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2>üìù Image Settings</h2>
                
                <div class="form-group">
                    <label for="apiKey">API Key *</label>
                    <input type="password" id="apiKey" placeholder="Enter your ByteDance API key" value="8d41474c-ed9f-4044-9649-10c67c92eb45">
                </div>

                <div class="form-group">
                    <label for="prompt">Image Description *</label>
                    <textarea id="prompt" placeholder="Describe the image you want to generate..." maxlength="5000"></textarea>
                    <small style="color: #6c757d; font-size: 12px;">Characters: <span id="charCount">0</span>/5000</small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="size">Image Size</label>
                        <select id="size">
                            <option value="1K">1K</option>
                            <option value="2K" selected>2K</option>
                            <option value="4K">4K</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="watermark">Watermark</label>
                        <select id="watermark">
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="responseFormat">Response Format</label>
                        <select id="responseFormat">
                            <option value="url" selected>URL</option>
                            <option value="b64_json">Base64 JSON</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="sequentialGeneration">Sequential Generation</label>
                        <select id="sequentialGeneration">
                            <option value="disabled">Disabled</option>
                            <option value="auto">Auto</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" id="maxImagesGroup" style="display: none;">
                    <label for="maxImages">Max Images (when Sequential = Auto)</label>
                    <select id="maxImages">
                        <option value="1">1 Image</option>
                        <option value="2">2 Images</option>
                        <option value="3">3 Images</option>
                        <option value="4">4 Images</option>
                        <option value="5">5 Images</option>
                        <option value="6">6 Images</option>
                    </select>
                </div>

                <button class="generate-btn" id="generateBtn" onclick="generateImages()">
                    üöÄ Generate Images (Instant!)
                </button>
            </div>

            <div class="results-section">
                <h2>üñºÔ∏è Generated Images</h2>
                
                <div id="statusContainer" style="display: none;">
                    <div class="status" id="status">
                        <div class="status-text" id="statusText"></div>
                    </div>
                </div>

                <div id="imageGallery" class="image-gallery"></div>

                <div id="emptyState" class="empty-state">
                    <p>üéØ Enter your image description and click "Generate Images" for instant results!</p>
                </div>

                <button class="download-all-btn" id="downloadAllBtn" onclick="downloadAllImages()" style="display: none;" disabled>
                    üì• Download All Images
                </button>

                <div class="history-section">
                    <button class="history-toggle" onclick="toggleHistory()">üìö View Generation History</button>
                    <div class="history-panel" id="historyPanel">
                        <div id="historyContent">
                            <p style="color: #6c757d; font-style: italic; text-align: center; padding: 20px;">No generations yet. Create some images to see them here!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let generatedImages = [];
        let downloadCount = 0;

        // Load saved settings on page load
        window.onload = function() {
            loadSavedSettings();
            setupEventListeners();
            updateSequentialOptions();
        };

        // Load API key and settings from localStorage
        function loadSavedSettings() {
            const apiKey = localStorage.getItem('bytedance_api_key');
            if (apiKey) {
                document.getElementById('apiKey').value = apiKey;
            }

            const savedPrompt = localStorage.getItem('bytedance_prompt');
            if (savedPrompt) {
                document.getElementById('prompt').value = savedPrompt;
                updateCharCount();
            }

            const savedSettings = JSON.parse(localStorage.getItem('bytedance_settings') || '{}');
            if (savedSettings.size) document.getElementById('size').value = savedSettings.size;
            if (savedSettings.watermark) document.getElementById('watermark').value = savedSettings.watermark;
            if (savedSettings.responseFormat) document.getElementById('responseFormat').value = savedSettings.responseFormat;
            if (savedSettings.sequentialGeneration) document.getElementById('sequentialGeneration').value = savedSettings.sequentialGeneration;
            if (savedSettings.maxImages) document.getElementById('maxImages').value = savedSettings.maxImages;
        }

        // Save settings to localStorage
        function saveSettings() {
            localStorage.setItem('bytedance_api_key', document.getElementById('apiKey').value);
            localStorage.setItem('bytedance_prompt', document.getElementById('prompt').value);
            
            const settings = {
                size: document.getElementById('size').value,
                watermark: document.getElementById('watermark').value,
                responseFormat: document.getElementById('responseFormat').value,
                sequentialGeneration: document.getElementById('sequentialGeneration').value,
                maxImages: document.getElementById('maxImages').value
            };
            localStorage.setItem('bytedance_settings', JSON.stringify(settings));
        }

        // Setup event listeners
        function setupEventListeners() {
            // Character count for prompt
            document.getElementById('prompt').addEventListener('input', updateCharCount);
            
            // Save settings on change
            document.getElementById('apiKey').addEventListener('change', saveSettings);
            document.getElementById('prompt').addEventListener('change', saveSettings);
            document.getElementById('size').addEventListener('change', saveSettings);
            document.getElementById('watermark').addEventListener('change', saveSettings);
            document.getElementById('responseFormat').addEventListener('change', saveSettings);
            document.getElementById('sequentialGeneration').addEventListener('change', function() {
                updateSequentialOptions();
                saveSettings();
            });
            document.getElementById('maxImages').addEventListener('change', saveSettings);
        }

        // Update character count
        function updateCharCount() {
            const prompt = document.getElementById('prompt').value;
            document.getElementById('charCount').textContent = prompt.length;
        }

        // Update sequential generation options
        function updateSequentialOptions() {
            const sequentialGeneration = document.getElementById('sequentialGeneration').value;
            const maxImagesGroup = document.getElementById('maxImagesGroup');
            
            if (sequentialGeneration === 'auto') {
                maxImagesGroup.style.display = 'block';
            } else {
                maxImagesGroup.style.display = 'none';
            }
        }

        // Show status message
        function showStatus(message, type = 'waiting') {
            const statusContainer = document.getElementById('statusContainer');
            const status = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            
            statusContainer.style.display = 'block';
            status.className = `status ${type}`;
            
            if (type === 'waiting') {
                statusText.innerHTML = `<div class="loading-spinner"></div>${message}`;
            } else {
                statusText.innerHTML = message;
            }
        }

        // Hide status message
        function hideStatus() {
            document.getElementById('statusContainer').style.display = 'none';
        }

        // Generate images
        async function generateImages() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const prompt = document.getElementById('prompt').value.trim();

            if (!apiKey) {
                alert('Please enter your API key');
                return;
            }

            if (!prompt) {
                alert('Please enter an image description');
                return;
            }

            // Save settings
            saveSettings();

            // Reset state
            generatedImages = [];
            downloadCount = 0;
            document.getElementById('imageGallery').innerHTML = '';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('downloadAllBtn').style.display = 'none';
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateBtn').textContent = '‚è≥ Generating...';

            showStatus('üöÄ Generating your images instantly...', 'waiting');

            try {
                // Prepare request data for ByteDance API
                const requestData = {
                    model: "seedream-4-0-250828",
                    prompt: prompt,
                    response_format: document.getElementById('responseFormat').value,
                    size: document.getElementById('size').value,
                    watermark: document.getElementById('watermark').value === 'true',
                    stream: false
                };

                // Add sequential generation options if enabled
                const sequentialGeneration = document.getElementById('sequentialGeneration').value;
                if (sequentialGeneration === 'auto') {
                    requestData.sequential_image_generation = 'auto';
                    requestData.sequential_image_generation_options = {
                        max_images: parseInt(document.getElementById('maxImages').value)
                    };
                } else {
                    requestData.sequential_image_generation = 'disabled';
                }

                console.log('ByteDance API request:', requestData);

                // Call ByteDance API
                const response = await fetch('https://ark.ap-southeast.bytepluses.com/api/v3/images/generations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData),
                    mode: 'cors'
                });

                console.log('ByteDance API response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                let result;
                try {
                    result = await response.json();
                    console.log('ByteDance API response:', result);
                } catch (jsonError) {
                    console.error('Failed to parse JSON response:', jsonError);
                    throw new Error('Invalid response from server. Please check your API key and try again.');
                }

                if (result.data && result.data.length > 0) {
                    showStatus(`‚úÖ Generated ${result.data.length} image(s) successfully!`, 'success');
                    displayImages(result.data);
                    
                    // Save to history
                    saveToHistory(prompt, result.data);
                } else {
                    throw new Error('No images were generated');
                }

            } catch (error) {
                console.error('Generation error:', error);
                let errorMessage = error.message;
                
                if (error.message === 'Failed to fetch') {
                    errorMessage = 'Network error: Unable to connect to ByteDance API. This might be a CORS issue or the API endpoint is not accessible. Try using a local server or check your internet connection.';
                }
                
                showStatus(`‚ùå Error: ${errorMessage}`, 'error');
            } finally {
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('generateBtn').textContent = 'üöÄ Generate Images (Instant!)';
            }
        }

        // Display generated images
        function displayImages(imageData) {
            generatedImages = imageData.map(img => img.url);
            const gallery = document.getElementById('imageGallery');
            
            imageData.forEach((img, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                imageItem.innerHTML = `
                    <img src="${img.url}" alt="Generated Image ${index + 1}" loading="lazy">
                    <div style="margin: 5px 0; font-size: 12px; color: #6c757d;">${img.size || 'Unknown size'}</div>
                    <button class="download-btn" onclick="downloadImage('${img.url}', ${index})">
                        üì• Download
                    </button>
                `;
                gallery.appendChild(imageItem);
            });

            document.getElementById('downloadAllBtn').style.display = 'block';
            document.getElementById('downloadAllBtn').disabled = false;
        }

        // Download individual image
        function downloadImage(url, index) {
            const link = document.createElement('a');
            link.href = url;
            link.download = `bytedance-generated-image-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}-${index + 1}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            downloadCount++;
            updateDownloadAllButton();
        }

        // Download all images
        function downloadAllImages() {
            if (generatedImages.length === 0) return;

            document.getElementById('downloadAllBtn').disabled = true;
            document.getElementById('downloadAllBtn').textContent = '‚è≥ Downloading...';

            generatedImages.forEach((url, index) => {
                setTimeout(() => {
                    downloadImage(url, index);
                }, index * 500); // Stagger downloads by 500ms
            });

            setTimeout(() => {
                document.getElementById('downloadAllBtn').disabled = false;
                document.getElementById('downloadAllBtn').textContent = 'üì• Download All Images';
                downloadCount = generatedImages.length;
                updateDownloadAllButton();
            }, generatedImages.length * 500 + 1000);
        }

        // Update download all button state
        function updateDownloadAllButton() {
            const downloadAllBtn = document.getElementById('downloadAllBtn');
            if (downloadCount >= generatedImages.length && generatedImages.length > 0) {
                downloadAllBtn.textContent = '‚úÖ All Downloaded';
                downloadAllBtn.disabled = true;
            } else if (generatedImages.length > 0) {
                downloadAllBtn.textContent = `üì• Download All (${downloadCount}/${generatedImages.length})`;
                downloadAllBtn.disabled = false;
            }
        }

        // History management
        function saveToHistory(prompt, imageData) {
            const history = JSON.parse(localStorage.getItem('bytedance_history') || '[]');
            
            const generation = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                prompt: prompt,
                imageData: imageData,
                settings: {
                    size: document.getElementById('size').value,
                    watermark: document.getElementById('watermark').value,
                    responseFormat: document.getElementById('responseFormat').value,
                    sequentialGeneration: document.getElementById('sequentialGeneration').value,
                    maxImages: document.getElementById('maxImages').value
                }
            };
            
            history.unshift(generation);
            
            // Keep only last 20 generations
            if (history.length > 20) {
                history.splice(20);
            }
            
            localStorage.setItem('bytedance_history', JSON.stringify(history));
        }

        function toggleHistory() {
            const historyPanel = document.getElementById('historyPanel');
            const toggleBtn = document.querySelector('.history-toggle');
            
            if (historyPanel.style.display === 'none' || historyPanel.style.display === '') {
                historyPanel.style.display = 'block';
                toggleBtn.textContent = '‚ùå Hide History';
                loadHistory();
            } else {
                historyPanel.style.display = 'none';
                toggleBtn.textContent = 'üìö View Generation History';
            }
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('bytedance_history') || '[]');
            const historyContent = document.getElementById('historyContent');
            
            if (history.length === 0) {
                historyContent.innerHTML = '<p style="color: #6c757d; font-style: italic; text-align: center; padding: 20px;">No generations yet. Create some images to see them here!</p>';
                return;
            }
            
            let html = '<div style="display: grid; gap: 15px;">';
            
            history.forEach(generation => {
                const date = new Date(generation.timestamp).toLocaleString();
                html += `
                    <div style="background: white; padding: 15px; border-radius: 10px; border: 1px solid #e9ecef;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: #495057;">${generation.prompt.substring(0, 60)}${generation.prompt.length > 60 ? '...' : ''}</h4>
                            <small style="color: #6c757d;">${date}</small>
                        </div>
                        <div style="margin-bottom: 10px; font-size: 12px; color: #6c757d;">
                            <strong>Settings:</strong> ${generation.settings.size} | Watermark: ${generation.settings.watermark} | Sequential: ${generation.settings.sequentialGeneration}
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;">
                `;
                
                generation.imageData.forEach((img, index) => {
                    html += `
                        <div style="text-align: center;">
                            <img src="${img.url}" style="width: 100%; height: 80px; object-fit: cover; border-radius: 6px; margin-bottom: 5px;" alt="History Image ${index + 1}">
                            <button onclick="downloadImage('${img.url}', ${index})" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer;">
                                üì• Download
                            </button>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        <button onclick="loadPromptFromHistory('${generation.prompt.replace(/'/g, "\\'")}')" style="background: #ff6b6b; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-top: 10px;">
                            üîÑ Use This Prompt
                        </button>
                    </div>
                `;
            });
            
            html += '</div>';
            historyContent.innerHTML = html;
        }

        function loadPromptFromHistory(prompt) {
            document.getElementById('prompt').value = prompt;
            updateCharCount();
            saveSettings();
            
            // Hide history panel
            document.getElementById('historyPanel').style.display = 'none';
            document.querySelector('.history-toggle').textContent = 'üìö View Generation History';
        }

        // API switching functions
        function switchToKieAI() {
            window.location.href = 'index.html';
        }

        function switchToByteDance() {
            // Already on ByteDance version
            console.log('Already using ByteDance API');
        }
    </script>
</body>
</html>
